%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%        1         2         3         4         5         6         7         8

\documentclass[letterpaper, 11 pt, conference]{ieeeconf}

% This command is only needed if 
% you want to use the \thanks command
\IEEEoverridecommandlockouts

% Needed to meet printer requirements.
\overrideIEEEmargins                                     

%In case you encounter the following error:
%Error 1010 The PDF file may be corrupt (unable to open PDF file) OR
%Error 1000 An error occurred while parsing a contents stream. Unable to analyze the PDF file.
%This is a known problem with pdfLaTeX conversion filter. The file cannot be opened with acrobat reader
%Please use one of the alternatives below to circumvent this error by uncommenting one or the other
%\pdfobjcompresslevel=0
%\pdfminorversion=4

% See the \addtolength command later in the file to balance the column lengths
% on the last page of the document

% The following packages can be found on http:\\www.ctan.org
%\usepackage{graphics} % for pdf, bitmapped graphics files
%\usepackage{epsfig} % for postscript graphics files
%\usepackage{mathptmx} % assumes new font selection scheme installed
%\usepackage{times} % assumes new font selection scheme installed
\usepackage{amsmath} % assumes amsmath package installed
\usepackage{amssymb}  % assumes amsmath package installed

\title{\LARGE \bf Sensitivity Analysis for Neural Network Controllers}


\author{Kyle Morgenstein$^{1,2}$\\kjm3887% <-this % stops a space
% \thanks{*This work was not supported by any organization}% <-this % stops a space
\thanks{$^{1}$Aerospace Engineering,
        UT Austin
        {\tt\small kylem@utexas.edu}}%
\thanks{$^{2}$Apptronik, Inc.
        {\tt\small kylemorgenstein@apptronik.com}}%
}


\begin{document}



\maketitle
\thispagestyle{empty}
\pagestyle{empty}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{abstract}


\end{abstract}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{INTRODUCTION}

Reinforcement learning (RL) has become the standard control technique in legged locomotion due to its robustness, expressivity, and ease of deployment.
Despite these attributes, RL control policies still fail catastrophically when evaluated on out of distribution (OOD) inputs.
Due to the black box nature of RL policies, safety efforts largely focus on observing potentially destabilizing changes in the action space of the policy, and triggering safe modes when risk thresholds are reached (e.g. over-current protection).
Efforts to quantify the distribution of valid inputs during training may result in more proactive runtime anomaly detection, but such efforts provide only weak guarantees of stability given the distribution shift between simulation-based training and hardware deployment.
In this work we propose a more rigorous treatment of anomaly detection using tools from nonlinear sensitivity analysis.
Treating the trained policy as an artifact, we aim to exploit the structure of the learning-based controller to provide stronger guarantees to prevent catastrophic failure at runtime.

\section{SYSTEM MODELING}

Consider a nonlinear, time varying system
\begin{equation}
\dot x_t = f(x_t) + g(x_t)u_t
\end{equation}
with state $x_t\in\mathbb{R}^n$ and control signal $u_t\in\mathbb{R}^m$.
We seek to understand the sensitivity of the closed loop dynamics without assuming knowledge of $f$ or $g$.
Let $u_t = \pi(z_t)$ be the output from a neural network controller tracking a reference signal such that the error dynamics
\begin{equation}
\begin{split}
z_t &:=x_t-x^\text{ref}_t \\
\dot z_t &= F(z_t, \pi(z_t))
\end{split}
\end{equation}
has an equilibrium at $F(0,\pi(0))=0\forall t$.
The linearized closed loop system Jacobian
\begin{equation}
J_\text{cl} = \frac{\partial F}{\partial z_t}\bigg\vert_{z_t=0} 
\end{equation}
and can be estimated as follows:

For $k=1,...,N$ select perturbation direction $d^{(k)}\in\mathbb{R}^n$ with $||d^{(k)}||=1$ and radius $h\in\mathbb{R}$.
Then define the forward difference
\begin{equation}
% y^{(k)} := \frac{F(hd^{(k)})-F(-hd^{(k)})}{2h}
y^{(k)} := \frac{F(hd^{(k)})-F(0)}{h}
\end{equation}
with estimator $y^{(k)}=J_\text{cl}d^{(k)}+\frac{r^{(k)}}{h}$ and remainder $r^{(k)}=\frac{1}{2}(hd^{(k)})^T\mathcal{H}(hd^{(k)})=\mathcal{O}(h^2)$.
Let $Y=[y^{(1)},...,y^{(N)}]\in\mathbb{R}^{n\times N}$, $D=[d^{(1)},...,d^{(N)}]\in\mathbb{R}^{n\times N}$ and $R=[\frac{r^{(1)}}{h},...,\frac{r^{(N)}}{h}]\in\mathbb{R}^{n\times N}$.
Then, 
\begin{equation}
\begin{split}
Y&=J_\text{cl} D+R \\
\hat J_\text{cl} &= YD^T(DD^T)^{-1}
\end{split}
\end{equation}
if $DD^T$ is invertible (i.e. $\{d^{(k)}\}$ spans $\mathbb{R}^n$).
A valid choice of $\{d^{(k)}\}$ requires $N\geq n$.

To show convergence to the equilibrium, we must show that $J_\text{cl}$ is Hurwitz.
Define the estimation error 
\begin{equation}
\Delta J_\text{cl} := \hat J_\text{cl} - J_\text{cl}.
\end{equation}
From the estimator model we have
\begin{equation} \label{esterror}
\Delta J_\text{cl} = RD^T(DD^T)^{-1}
\end{equation}
with bound $||\Delta J_\text{cl}||_2\leq||R||_2||D^T(DD^T)^{-1}||_2$.
Using the singular value decomposition $D=U\Sigma V^T$, the directional term on the right-hand side can be simplified $D^T(DD^T)^{-1}=V\Sigma^{-1} U^T$, yielding
\begin{equation} \label{Dsigma}
||D^T(DD^T)^{-1}||_2=\frac{1}{\sigma_\text{min}(D)}.
\end{equation}
Where $\{d^{(k)}\}$ is selected as $N$ i.i.d unit norm isotropic random directions, $DD^T\approx \frac{N}{n}I$ results in $\sigma_\text{min}(D)\approx\sqrt{\frac{N}{n}}$ with high probability for large $N$.
Next, by assuming $F\in\mathcal{C}^2$, we can bound the second-order Taylor remainder as $||\frac{r^{(k)}}{h}||_2\leq\frac{1}{2}L_2h||d^{(k)}||_2$.
The constant $L_2$ can be estimated via the second directional derivative
\begin{equation}
\begin{split}
\hat L_2&=\sup_{||d||=1}||D^2F(0)[d,d]||_2\\
&\approx \max_k \bigg|\bigg|\frac{F(hd^{(k)})-2F(0)+F(-hd^{(k)})}{h^2}\bigg|\bigg|
\end{split}
\end{equation}
To account for numerical error, a small scale may be used $L_2=\beta\hat L_2$, $\beta> 1$.
Then,
\begin{equation} \label{Rbound}
% ||R||_2\leq\max_k||r^{(k)}||_2\sqrt{N} 
\begin{split}
||R||_2&\leq\max_k||\frac{r^{(k)}}{h}||_2\sqrt{\text{rank}(R)} \\
&\leq\max_k||\frac{r^{(k)}}{h}||_2\sqrt{\min(n,N)} \\
&\leq\frac{1}{2}L_2h\sqrt{n}
\end{split}
\end{equation}
using the requirement that $\{d^{(k)}\}$ spans $\mathbb{R}^n$.
% with factor $\sqrt{N}$ the spectral norm of a matrix whose columns are each size $\frac{1}{2}L_2h^2$.
Substituting bounds into Eq. \ref{esterror}, we find a computable bound on the estimation error
\begin{equation}
||\Delta J_\text{cl}||_2\leq\frac{1}{2}L_2h\frac{n}{\sqrt{N}}
\end{equation}

From this upper bound we may now derive the conditions to certify that $J_\text{cl}$ is Hurwitz given $\hat J_\text{cl}$.
Assume $J_\text{cl}$ is diagonalizable.
Let $\hat J_\text{cl}=V\Lambda V^{-1}$ with eigenvalues $\{\hat \lambda_i\}$ and margin $\hat \lambda = -\max_i \operatorname{Re}{\hat \lambda_i}$.
The Baur-Fike Theorem \cite{bauer1960norms} gives a bound on the distance between an eigenvalue $\lambda_i$ of $J_\text{cl}=\hat J_\text{cl} - \Delta J_\text{cl}$ and $\hat \lambda_i$:
\begin{equation}
\begin{split}
|\lambda_i-\hat \lambda_i|&\leq\kappa(V)||\Delta J_\text{cl}||_2 \\
&\leq\kappa(V)\frac{1}{2}L_2h\frac{n}{\sqrt{N}}
\end{split}
\end{equation}
with condition number $\kappa(V)=||V||_2||V^{-1}||_2$ for the matrix of eigenvectors of $\hat J_\text{cl}$.
Therefore, if 
\begin{equation} \label{datboi}
\kappa(V)\frac{1}{2}L_2h\frac{n}{\sqrt{N}}\leq\hat\lambda
\end{equation}
then
\begin{equation}
\begin{split}
\operatorname{Re}{\lambda_i}&\leq\operatorname{Re}{\hat \lambda_i}+|\lambda_i-\hat\lambda_i|\\
&\leq-\hat\lambda+\kappa(V)\frac{1}{2}L_2h\frac{n}{\sqrt{N}}\\
&<0\forall\lambda_i.
\end{split}
\end{equation}
Thus, Eq. \ref{datboi} is sufficient to conclude that $J_\text{cl}$ is Hurwitz.
We have now certified that the closed loop dynamics are locally exponentially stable based on the sampled response within the perturbation radius $h$ for each $t>t_0$.
This proof holds despite only assuming $J_\text{cl}$ is diagonalizable, $\{d^{(k)}\}$ is full rank, and $F\in\mathcal{C}^2$.






\section{SYSTEM ANALYSIS AND DESIGN}

\section{SIMULATION RESULTS}

\section{CONCLUSIONS}






\section{MATH}




\subsection{Equations}

The equations are an exception to the prescribed specifications of this template. You will need to determine whether or not your equation should be typed using either the Times New Roman or the Symbol font (please no other font). To create multileveled equations, it may be necessary to treat the equation as a graphic and insert it into the text after your paper is styled. Number equations consecutively. Equation numbers, within parentheses, are to position flush right, as in (1), using a right tab stop. To make your equations more compact, you may use the solidus ( / ), the exp function, or appropriate exponents. Italicize Roman symbols for quantities and variables, but not Greek symbols. Use a long dash rather than a hyphen for a minus sign. Punctuate equations with commas or periods when they are part of a sentence, as in

$$
\alpha + \beta = \chi \eqno{(1)}
$$

Note that the equation is centered using a center tab stop. Be sure that the symbols in your equation have been defined before or immediately following the equation. Use ``(1)'', not ``Eq. (1)'' or ``equation (1)'', except at the beginning of a sentence: ``Equation (1) is . . .''


\subsection{Figures and Tables}

Positioning Figures and Tables: Place figures and tables at the top and bottom of columns. Avoid placing them in the middle of columns. Large figures and tables may span across both columns. Figure captions should be below the figures; table heads should appear above the tables. Insert figures and tables after they are cited in the text. Use the abbreviation ``Fig. 1'', even at the beginning of a sentence. \cite{hermann77}

\begin{table}[h]
\caption{An Example of a Table}
\label{table_example}
\begin{center}
\begin{tabular}{|c||c|}
\hline
One & Two\\
\hline
Three & Four\\
\hline
\end{tabular}
\end{center}
\end{table}


\begin{figure}[thpb]
\centering
\framebox{\parbox{3in}{We suggest that you use a text box to insert a graphic (which is ideally a 300 dpi TIFF or EPS file, with all fonts embedded) because, in an document, this method is somewhat more stable than directly inserting a picture.
}}
%\includegraphics[scale=1.0]{figurefile}
\caption{Inductance of oscillation winding on amorphous
magnetic core versus DC bias magnetic field}
\label{figurelabel}
\end{figure}


% This command serves to balance the column lengths
% on the last page of the document manually. It shortens
% the text height of the last page by a suitable amount.
% This command does not take effect until the next page
% so it should come on the page before the last. Make
% sure that you do not shorten the text height too much.
\addtolength{\textheight}{-12cm}  

\nocite{*}
\bibliographystyle{IEEEtran}
\bibliography{IEEEabrv,references}

\end{document}
